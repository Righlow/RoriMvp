<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EchoSpace Visualiser</title>

  <style>
    :root {
      --blue-bg: #264cff;
      --card-yellow: #ffe94a;
      --accent-red: #ff4f5e;
      --neon-yellow: #d9ff3f;
      --text-dark: #111111;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      height: 100vh;
      overflow: hidden;
      background: var(--blue-bg);
      color: white;
      display: flex;
      flex-direction: column;
      font-family: "Inter", sans-serif;
    }

    #ui-layer {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      pointer-events: none;
      transition: padding 0.3s ease, transform 0.3s ease;
    }

    .card {
      background: var(--card-yellow);
      pointer-events: auto;
      padding: 40px 56px;
      border-radius: 32px;
      border: 6px solid #000;
      text-align: center;
      max-width: 420px;
      color: var(--text-dark);
      box-shadow: 16px 16px 0 #000;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card-title {
      font-size: 3.4rem;
      font-weight: 800;
      letter-spacing: 0.12em;
      color: var(--accent-red);
      text-shadow: 0 4px 0 #000;
      margin-bottom: 18px;
    }

    .card-sub {
      font-size: 0.9rem;
      font-weight: 700;
      margin-bottom: 30px;
    }

    #visualiser { flex: 1; cursor: pointer; }
  </style>
</head>

<body>

<!-- UI BANNER (shrinks when music starts) -->
<div id="ui-layer">
  <div class="card">
    <div class="card-title">SONIQ SPACE</div>
    <div class="card-sub">KEEP YOUR EARS ON THE ECHO.</div>
    <div style="font-size: 0.9rem; font-weight: bold;">
      LOADING YOUR TRACK...
    </div>
  </div>
</div>

<div id="visualiser"></div>

<!-- Three.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/js/loaders/FontLoader.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/js/geometries/TextGeometry.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/simplex-noise/2.3.0/simplex-noise.min.js"></script>

<script>
  // ---------------------------
  // AUTO LOAD TRACK FROM SERVER
  // ---------------------------
  const serverFile = "/upload/<%= filename %>";  
  let audio = new Audio(serverFile);
  audio.loop = true;

  let audioContext, analyser, dataArray;
  let scene, camera, renderer;
  let wavePoints, wavePositions;
  let tube;
  let textMesh;
  let depthPoints, depthPositions, depthBasePositions;
  let renderTarget, rttCamera;
  let cubeCamera, cubeRenderTarget, refractSphere;

  let textScaleTarget = 0;
  let hasStarted = false;

  const visualiserEl = document.getElementById("visualiser");
  const uiLayer = document.getElementById("ui-layer");

  const noise = new SimplexNoise();

  // Start visualiser automatically
  startVisualiser();

  // Click to play/pause
  visualiserEl.addEventListener("click", () => {
    if (audio.paused) {
      audio.play();
      if (audioContext.state === "suspended") audioContext.resume();
      textScaleTarget = 1;

      if (!hasStarted) {
        document.body.classList.add("started");
        hasStarted = true;
      }
    } else {
      audio.pause();
      textScaleTarget = 0;
    }
  });

  // -----------------------------------------------------
  // START 3D VISUALISER
  // -----------------------------------------------------
  function startVisualiser() {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioContext.createMediaElementSource(audio);

    analyser = audioContext.createAnalyser();
    src.connect(analyser);
    analyser.connect(audioContext.destination);

    analyser.fftSize = 512;
    dataArray = new Uint8Array(analyser.frequencyBinCount);

    // --- THREE.JS SETUP ---
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x264cff);

    camera = new THREE.PerspectiveCamera(
      60,
      window.innerWidth / window.innerHeight,
      0.1,
      1000
    );
    camera.position.set(0, 50, 160);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    visualiserEl.innerHTML = "";
    visualiserEl.appendChild(renderer.domElement);

    // Render-to-texture camera
    rttCamera = camera.clone();

    // Lights
    scene.add(new THREE.AmbientLight(0xffffff, 0.35));
    const d = new THREE.DirectionalLight(0xffffff, 1.0);
    d.position.set(60, 90, 60);
    scene.add(d);

    // Wave points
    const gridX = 80, gridZ = 80, separation = 2.4;
    const count = gridX * gridZ;
    wavePositions = new Float32Array(count * 3);

    let wi = 0;
    for (let x = 0; x < gridX; x++)
      for (let z = 0; z < gridZ; z++) {
        wavePositions[wi++] = (x - gridX / 2) * separation;
        wavePositions[wi++] = 0;
        wavePositions[wi++] = (z - gridZ / 2) * separation;
      }

    const waveGeometry = new THREE.BufferGeometry();
    waveGeometry.setAttribute("position", new THREE.BufferAttribute(wavePositions, 3));

    wavePoints = new THREE.Points(
      waveGeometry,
      new THREE.PointsMaterial({ size: 1.6, color: 0xd9ff3f })
    );
    wavePoints.position.y = -16;
    scene.add(wavePoints);

    window.addEventListener("resize", onWindowResize);
    animate();
  }

  // Resize
  function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  }

  // -----------------------------------------------------
  // MAIN ANIMATION LOOP
  // -----------------------------------------------------
  function animate() {
    requestAnimationFrame(animate);

    analyser.getByteFrequencyData(dataArray);

    const bass = avg(dataArray.slice(0, dataArray.length / 3)) / 255;
    const mid = avg(dataArray.slice(dataArray.length / 3)) / 255;
    const time = performance.now() * 0.0007;

    // Camera movement
    camera.position.x = Math.cos(time * 0.55) * (150 + mid * 40);
    camera.position.z = Math.sin(time * 0.55) * (150 + mid * 40);
    camera.position.y = 55 + bass * 40;
    camera.lookAt(0, 26, 0);

    // Wave animation
    const pos = wavePoints.geometry.attributes.position.array;
    let i = 0;
    for (let x = 0; x < 80; x++)
      for (let z = 0; z < 80; z++) {
        const n = noise.noise3D(x / 12, z / 12, time * 2.0);
        pos[i + 1] = n * (6 + bass * 45);
        i += 3;
      }
    wavePoints.geometry.attributes.position.needsUpdate = true;

    renderer.render(scene, camera);
  }

  function avg(arr) {
    return arr.reduce((a, b) => a + b, 0) / arr.length;
  }
</script>

</body>
</html>
